SSO请求流程：

1. 未登陆的用户请求**服务器资源**，被本地服务器的LoginFilter拦截，发现其请求的Session数据没有记录在本地服务器中，请求的url也并没有携带code授权码参数。**于是向第三方登陆服务器跳转**

2. 在用户进行显式的授权（**登陆密码的输入**）后，向第三方登陆服务器发起请求，**第三方服务器校验服务器是否合法**，**再校验用户账号是否无误，无误后，第三方服务器生成tgt，存储在本地，也加入用户的Cookie当中**，**然后生成授权码，内部继续重定向到客户端的资源页面**

3. 此时再次进入客户端的拦截器，客户端仍然没有该请求的Session数据，但这一次携带了CAS颁发的授权码，于是客户端通过远程调用并携带该授权码（Oauth2协议，当登陆服务器与app在一起时，code授权码不对外暴露），向客户端验证该授权码的有效性,验证成功后，向该请求的session中存放SESSION_ACCESS_TOKEN

4. 此时，第三方登陆服务器检验本地是否有该授权码，如有，则取出对应授权用户的信息，并移除该授权码。并在本地生成一个token令牌，记录令牌与用户，授权码之间的关系，还记录登陆凭证tgt与名下令牌的关系，返回给客户端令牌与刷新令牌

5. 客户端调用成功之后，在本地记录该令牌与session（用户请求）（向session中setArtribute，记录过期时间）的关系，![image-20211105111358732](C:\Users\pro\AppData\Roaming\Typora\typora-user-images\image-20211105111358732.png)

   同时再次内部重定向到本地的资源页面

6. 此时请求再再此进入客户端的拦截器，但此时客户端的session中已经有了记录，所以正确的访问到了资源。

图片云盘（p站）
1. 推荐算法
  1. 使用KMP 匹配爱好，选出分类中最符合爱好的三种
  2. 根据爱好，自学习新的分类（待实现）   
2. 缓存淘汰算法
  1. 上述爱好的图片信息都将被缓存至guava的cache中，避免大量查询数据库
3. 分片上传
  1. 使用线程池
  2. 限制用户上传的数量
  3. 上传考虑使用KMP匹配文件名，到指定分类
  4. 使用Callable任务 + 阻塞队列，将对数据库增加信息与图片信息转储到本地   
4. 根据点击量排序热度
  1. 使用redis的Zset实现
5. 每张图片需要开启评论区
6. 用户分类
  1. 普通用户---检测是否是第一次登陆，否则在本地记录信息
  2. 特权用户---看到某些付费图片
  3. 管理员---审核图片
  4. 所有用户都具有上传和访问首页的权限
7. 不同的接口需要不同拥有指定的权限等级才能访问，或可视
   1.设置权限拦截器
8. 在mysql时间戳上建立索引，获取图片时倒序获取
9. 设置Refer拦截器，避免csrf攻击
    1. 指定域名跳转过来的才能访问
10. 设置云盘用户状态拦截器    

遇到的问题
1. 在某些类，变量使用@Autowired注入，运行时仍然为空？
  回答：该类并不在spring容器的管辖范围内，不会扫描该AutoWired注解，使用SpringContextHolder工具类
   获取springIOc的上下文信息可解决该问题
2. 遇到redis库莫名被清空，然后出现四个backup文件，里面是一段脚本，怀疑被黑了
  回答：设置了requirepass，以及禁用了config指令之后没有再出现这种状况
  ![QQ截图20220128160003](C:\Users\pro\IdeaProjects\sso-smart\smart-sso\SSO请求流程.assets\QQ截图20220128160003.png)
3. 